## Snowly Compute Usage Module
Procedure to sync compute relevant tables from SNOWFLAKE database into SHARE_USAGE database. 
The procedure will create the tables if they do not exists


## Install
Run to following script using ACCOUNTADMIN Role
```sql
Use role ACCOUNTADMIN;

CREATE OR REPLACE PROCEDURE SHARE_USAGE.ACCOUNT_USAGE.SP_ACCOUNT_USAGE_DATA(LOAD_METHOD STRING)
RETURNS STRING
LANGUAGE javascript
strict
EXECUTE AS owner
AS

$$

// SET VARIABLES
var SP_VERSION = `2.3`;
var TASK_NAME = `TASK_ACCOUNT_USAGE`;
var RUN_ID = Date.now().toString();

var full_script = `
Create table if not exists  ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG (
RUN_ID STRING,
TASK_NAME STRING,
OBJECT_NAME STRING,
EVENT_NAME STRING,
EVENT_TS timestamp_ntz,
SP_VERSION STRING,
EVENT_DATA VARIANT
);
/*cmd separator*/
Create  table if not exists ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY as
Select START_TIME,END_TIME,WAREHOUSE_ID,WAREHOUSE_NAME,CREDITS_USED,CREDITS_USED_COMPUTE,CREDITS_USED_CLOUD_SERVICES, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."WAREHOUSE_METERING_HISTORY"
Where  1=0;
/*cmd separator*/
Insert into ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY (START_TIME,END_TIME,WAREHOUSE_ID,WAREHOUSE_NAME,CREDITS_USED,CREDITS_USED_COMPUTE,CREDITS_USED_CLOUD_SERVICES,CREATED, EXTRA_COLUMNS)
Select START_TIME,END_TIME,WAREHOUSE_ID,WAREHOUSE_NAME,CREDITS_USED,CREDITS_USED_COMPUTE,CREDITS_USED_CLOUD_SERVICES, current_timestamp() CREATED,
       ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."WAREHOUSE_METERING_HISTORY"
Where  START_TIME > IFNULL((Select Max(START_TIME) From ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'WAREHOUSE_METERING_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Create  table if not exists ACCOUNT_USAGE.QUERY_HISTORY as
Select QUERY_ID ,QUERY_TEXT QUERY_TEXT ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE ,SESSION_ID ,USER_NAME ,ROLE_NAME ,
        WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE ,ERROR_MESSAGE ,
        START_TIME ,END_TIME ,TOTAL_ELAPSED_TIME ,BYTES_SCANNED ,ROWS_PRODUCED ,COMPILATION_TIME ,EXECUTION_TIME ,QUEUED_PROVISIONING_TIME ,
        QUEUED_REPAIR_TIME ,QUEUED_OVERLOAD_TIME ,TRANSACTION_BLOCKED_TIME ,OUTBOUND_DATA_TRANSFER_CLOUD ,OUTBOUND_DATA_TRANSFER_REGION ,
        OUTBOUND_DATA_TRANSFER_BYTES ,INBOUND_DATA_TRANSFER_CLOUD ,INBOUND_DATA_TRANSFER_REGION ,INBOUND_DATA_TRANSFER_BYTES,
       LIST_EXTERNAL_FILES_TIME,CREDITS_USED_CLOUD_SERVICES,ROWS_INSERTED,ROWS_DELETED,BYTES_SENT_OVER_THE_NETWORK,PERCENTAGE_SCANNED_FROM_CACHE,
            BYTES_READ_FROM_RESULT,BYTES_SPILLED_TO_LOCAL_STORAGE,PARTITIONS_TOTAL,BYTES_DELETED,ROWS_UNLOADED,BYTES_WRITTEN_TO_RESULT,
            ROWS_UPDATED,PARTITIONS_SCANNED,RELEASE_VERSION,BYTES_WRITTEN,
            BYTES_SPILLED_TO_REMOTE_STORAGE
        , current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
Where 1=0;
/*cmd separator*/
Insert Into ACCOUNT_USAGE.QUERY_HISTORY (QUERY_ID ,QUERY_TEXT ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE ,SESSION_ID ,USER_NAME ,ROLE_NAME ,
            WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE ,ERROR_MESSAGE ,
            START_TIME ,END_TIME ,TOTAL_ELAPSED_TIME ,BYTES_SCANNED ,ROWS_PRODUCED ,COMPILATION_TIME ,EXECUTION_TIME ,QUEUED_PROVISIONING_TIME ,
            QUEUED_REPAIR_TIME ,QUEUED_OVERLOAD_TIME ,TRANSACTION_BLOCKED_TIME ,OUTBOUND_DATA_TRANSFER_CLOUD ,OUTBOUND_DATA_TRANSFER_REGION ,
            OUTBOUND_DATA_TRANSFER_BYTES ,INBOUND_DATA_TRANSFER_CLOUD ,INBOUND_DATA_TRANSFER_REGION ,INBOUND_DATA_TRANSFER_BYTES,
            LIST_EXTERNAL_FILES_TIME,CREDITS_USED_CLOUD_SERVICES,ROWS_INSERTED,ROWS_DELETED,BYTES_SENT_OVER_THE_NETWORK,PERCENTAGE_SCANNED_FROM_CACHE,
            BYTES_READ_FROM_RESULT,BYTES_SPILLED_TO_LOCAL_STORAGE,PARTITIONS_TOTAL,BYTES_DELETED,ROWS_UNLOADED,BYTES_WRITTEN_TO_RESULT,
            ROWS_UPDATED,PARTITIONS_SCANNED,RELEASE_VERSION,BYTES_WRITTEN,
            BYTES_SPILLED_TO_REMOTE_STORAGE, CREATED, EXTRA_COLUMNS)
Select QUERY_ID ,QUERY_TEXT ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE ,SESSION_ID ,USER_NAME ,ROLE_NAME ,
            WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE ,ERROR_MESSAGE ,
            START_TIME ,END_TIME ,TOTAL_ELAPSED_TIME ,BYTES_SCANNED ,ROWS_PRODUCED ,COMPILATION_TIME ,EXECUTION_TIME ,QUEUED_PROVISIONING_TIME ,
            QUEUED_REPAIR_TIME ,QUEUED_OVERLOAD_TIME ,TRANSACTION_BLOCKED_TIME ,OUTBOUND_DATA_TRANSFER_CLOUD ,OUTBOUND_DATA_TRANSFER_REGION ,
            OUTBOUND_DATA_TRANSFER_BYTES ,INBOUND_DATA_TRANSFER_CLOUD ,INBOUND_DATA_TRANSFER_REGION ,INBOUND_DATA_TRANSFER_BYTES,
            LIST_EXTERNAL_FILES_TIME,CREDITS_USED_CLOUD_SERVICES,ROWS_INSERTED,ROWS_DELETED,BYTES_SENT_OVER_THE_NETWORK,PERCENTAGE_SCANNED_FROM_CACHE,
            BYTES_READ_FROM_RESULT,BYTES_SPILLED_TO_LOCAL_STORAGE,PARTITIONS_TOTAL,BYTES_DELETED,ROWS_UNLOADED,BYTES_WRITTEN_TO_RESULT,
            ROWS_UPDATED,PARTITIONS_SCANNED,RELEASE_VERSION,BYTES_WRITTEN,
            BYTES_SPILLED_TO_REMOTE_STORAGE, current_timestamp() CREATED,''::VARIANT

From "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
Where WAREHOUSE_SIZE is not null and START_TIME > IFNULL((Select Max(START_TIME) From ACCOUNT_USAGE.QUERY_HISTORY),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'QUERY_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/

Create table if not exists  ACCOUNT_USAGE.CLOUD_SERVICES_WO_WAREHOUSE_SIZE as
Select  LEFT(START_TIME , 13) HOUR_ID ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE  ,USER_NAME ,ROLE_NAME ,
        WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE  ,
        SUM(TOTAL_ELAPSED_TIME) SUM_TOTAL_ELAPSED_TIME ,SUM(CREDITS_USED_CLOUD_SERVICES) SUM_CREDITS_USED_CLOUD_SERVICES, COUNT(*) NUM_QUERIES
       ,MAX(ERROR_MESSAGE) ERROR_MESSAGE
       , current_timestamp()  CREATED, MAX(START_TIME) MAX_START_TIME, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
Where WAREHOUSE_SIZE is null  and 1=0
Group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16;
/*cmd separator*/
Insert into ACCOUNT_USAGE.CLOUD_SERVICES_WO_WAREHOUSE_SIZE (HOUR_ID ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE  ,USER_NAME ,ROLE_NAME ,
        WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE  ,SUM_TOTAL_ELAPSED_TIME ,
        SUM_CREDITS_USED_CLOUD_SERVICES, NUM_QUERIES,ERROR_MESSAGE, CREATED, MAX_START_TIME)
Select  LEFT(START_TIME , 13) HOUR_ID ,DATABASE_ID ,DATABASE_NAME ,SCHEMA_ID ,SCHEMA_NAME ,QUERY_TYPE  ,USER_NAME ,ROLE_NAME ,
        WAREHOUSE_ID ,WAREHOUSE_NAME ,WAREHOUSE_SIZE ,WAREHOUSE_TYPE ,CLUSTER_NUMBER ,QUERY_TAG ,EXECUTION_STATUS ,ERROR_CODE  ,
        SUM(TOTAL_ELAPSED_TIME) SUM_TOTAL_ELAPSED_TIME ,SUM(CREDITS_USED_CLOUD_SERVICES) SUM_CREDITS_USED_CLOUD_SERVICES, COUNT(*) NUM_QUERIES
       ,MAX(ERROR_MESSAGE) ERROR_MESSAGE
       , current_timestamp()  CREATED, MAX(START_TIME) MAX_START_TIME
From "SNOWFLAKE"."ACCOUNT_USAGE"."QUERY_HISTORY"
Where WAREHOUSE_SIZE is null
    and START_TIME > IFNULL((Select Max(MAX_START_TIME) From ACCOUNT_USAGE.CLOUD_SERVICES_WO_WAREHOUSE_SIZE),'2000-01-01')
Group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16;
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'CLOUD_SERVICES_WO_WAREHOUSE_SIZE', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/

Create table if not exists ACCOUNT_USAGE.PIPE_USAGE_HISTORY as
Select PIPE_ID,PIPE_NAME,START_TIME,END_TIME,CREDITS_USED,BYTES_INSERTED,FILES_INSERTED, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."PIPE_USAGE_HISTORY"
Where 1=0;
/*cmd separator*/
Insert into  ACCOUNT_USAGE.PIPE_USAGE_HISTORY (PIPE_ID,PIPE_NAME,START_TIME,END_TIME,CREDITS_USED,BYTES_INSERTED,FILES_INSERTED,CREATED,EXTRA_COLUMNS)
Select PIPE_ID,PIPE_NAME,START_TIME,END_TIME,CREDITS_USED,BYTES_INSERTED,FILES_INSERTED, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."PIPE_USAGE_HISTORY"
Where START_TIME > IFNULL((Select Max(START_TIME) From ACCOUNT_USAGE.PIPE_USAGE_HISTORY),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'PIPE_USAGE_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/

Create table if not exists ACCOUNT_USAGE.LOGIN_HISTORY as
Select EVENT_ID,EVENT_TIMESTAMP,EVENT_TYPE,USER_NAME,CLIENT_IP,REPORTED_CLIENT_TYPE,REPORTED_CLIENT_VERSION,FIRST_AUTHENTICATION_FACTOR,
       SECOND_AUTHENTICATION_FACTOR,IS_SUCCESS,ERROR_CODE,ERROR_MESSAGE,RELATED_EVENT_ID, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."LOGIN_HISTORY"
Where 1=0;
/*cmd separator*/
Insert into  ACCOUNT_USAGE.LOGIN_HISTORY (EVENT_ID,EVENT_TIMESTAMP,EVENT_TYPE,USER_NAME,CLIENT_IP,REPORTED_CLIENT_TYPE,REPORTED_CLIENT_VERSION,FIRST_AUTHENTICATION_FACTOR,SECOND_AUTHENTICATION_FACTOR,IS_SUCCESS,ERROR_CODE,ERROR_MESSAGE,RELATED_EVENT_ID,CREATED)
Select EVENT_ID,EVENT_TIMESTAMP,EVENT_TYPE,USER_NAME,CLIENT_IP,REPORTED_CLIENT_TYPE,REPORTED_CLIENT_VERSION,FIRST_AUTHENTICATION_FACTOR,SECOND_AUTHENTICATION_FACTOR,IS_SUCCESS,ERROR_CODE,ERROR_MESSAGE,RELATED_EVENT_ID, current_timestamp() CREATED
From "SNOWFLAKE"."ACCOUNT_USAGE"."LOGIN_HISTORY"
Where EVENT_TIMESTAMP > IFNULL((Select Max(EVENT_TIMESTAMP) From ACCOUNT_USAGE.LOGIN_HISTORY),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'LOGIN_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/

Create table if not exists ACCOUNT_USAGE.METERING_HISTORY as
Select SERVICE_TYPE,START_TIME, END_TIME, ENTITY_ID,NAME, CREDITS_USED_COMPUTE, CREDITS_USED_CLOUD_SERVICES, CREDITS_USED, BYTES, "ROWS" NUM_OF_ROWS, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."METERING_HISTORY"
Where 1=0;
/*cmd separator*/
Insert into  ACCOUNT_USAGE.METERING_HISTORY ( SERVICE_TYPE,START_TIME, END_TIME, ENTITY_ID,NAME, CREDITS_USED_COMPUTE, CREDITS_USED_CLOUD_SERVICES, CREDITS_USED, BYTES,NUM_OF_ROWS, CREATED, EXTRA_COLUMNS)
Select SERVICE_TYPE,START_TIME, END_TIME, ENTITY_ID,NAME, CREDITS_USED_COMPUTE, CREDITS_USED_CLOUD_SERVICES, CREDITS_USED, BYTES, "ROWS" NUM_OF_ROWS, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."METERING_HISTORY"
Where END_TIME > IFNULL((Select Max(END_TIME) From ACCOUNT_USAGE.METERING_HISTORY),'2000-01-01') AND END_TIME IS NOT NULL;
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'METERING_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Create table ACCOUNT_USAGE.META_DATA_CHANGES if not exists
(
    SOURCE_OBJECT VARCHAR,
    SOURCE_OBJECT_KEY VARCHAR,
    SOURCE_OBJECT_SCD_KEY VARCHAR,
    SOURCE_KEY_VALUE VARCHAR,
    DETAILED_DATA VARIANT,
    CREATED TIMESTAMP_LTZ
);
/*cmd separator*/
Create or replace  temp table ACCOUNT_USAGE.META_DATA_CHANGES_TMP
(
    SOURCE_OBJECT VARCHAR,
    SOURCE_OBJECT_KEY VARCHAR,
    SOURCE_OBJECT_SCD_KEY VARCHAR,
    SOURCE_KEY_VALUE VARCHAR,
    DETAILED_DATA VARIANT,
    CREATED TIMESTAMP_LTZ
);
/*cmd separator*/
show warehouses;
/*cmd separator*/
insert into  ACCOUNT_USAGE.META_DATA_CHANGES_TMP (SOURCE_OBJECT, SOURCE_OBJECT_KEY,SOURCE_OBJECT_SCD_KEY, SOURCE_KEY_VALUE,DETAILED_DATA, CREATED)
Select SOURCE_OBJECT, SOURCE_OBJECT_KEY,SOURCE_OBJECT_SCD_KEY, SOURCE_KEY_VALUE, DETAILED_DATA, CREATED
From (
      Select 'WAREHOUSES' SOURCE_OBJECT ,
                CONCAT("name") SOURCE_OBJECT_KEY,
                CONCAT("name",'|',"size",'|',"auto_suspend",'|',"auto_resume") SOURCE_OBJECT_SCD_KEY,
                CONCAT(left( current_timestamp(),16),'*snowly*',SOURCE_OBJECT_SCD_KEY) SOURCE_KEY_VALUE,
              object_construct('NAME',"name",'TYPE',"type" ,'SIZE',"size"
                              ,'AUTO_SUSPEND',"auto_suspend",'AUTO_RESUME',"auto_resume") DETAILED_DATA,
              current_timestamp() CREATED
      From TABLE(RESULT_SCAN ( LAST_QUERY_ID()  ))
  ) a;
/*cmd separator*/
insert into  ACCOUNT_USAGE.META_DATA_CHANGES (SOURCE_OBJECT, SOURCE_OBJECT_KEY,SOURCE_OBJECT_SCD_KEY,SOURCE_KEY_VALUE, DETAILED_DATA, CREATED)
Select SOURCE_OBJECT, SOURCE_OBJECT_KEY,SOURCE_OBJECT_SCD_KEY,SOURCE_KEY_VALUE, DETAILED_DATA, CREATED
From (
      Select  SOURCE_OBJECT ,
              SOURCE_OBJECT_KEY,
              SOURCE_OBJECT_SCD_KEY,
              SOURCE_KEY_VALUE,
              DETAILED_DATA,
              current_timestamp() CREATED
      From ACCOUNT_USAGE.META_DATA_CHANGES_TMP
  ) a
Where not exists (Select 1
                  From (Select SOURCE_OBJECT,SOURCE_OBJECT_KEY, split(max(SOURCE_KEY_VALUE),'*snowly*')[1]::STRING SOURCE_OBJECT_SCD_KEY
                          From ACCOUNT_USAGE.META_DATA_CHANGES
                          Group by 1,2) b
                  Where a.SOURCE_OBJECT=b.SOURCE_OBJECT
                        and a.SOURCE_OBJECT_KEY = b.SOURCE_OBJECT_KEY
                        and a.SOURCE_OBJECT_SCD_KEY = b.SOURCE_OBJECT_SCD_KEY
);
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'META_DATA_CHANGES', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));

/*cmd separator*/
`
var message='';
try
{
for (j = 0; j < full_script.split(';').length; j++){

    curr_sql=full_script.split(';')[j];

    if(curr_sql && curr_sql.length>20){
        if(LOAD_METHOD=='FULL'){
        curr_sql = curr_sql.replace('table if not exists',' or replace table ')
        }
        var snowflake_statement = snowflake.createStatement( {sqlText: curr_sql});
        var result = snowflake_statement.execute();
        message=message+'|'+curr_sql;
    }
}
return 'Success'

    }
catch (err)  {

  var failure_msg = "Failed: " + err
    return failure_msg

  }

$$;
```
