## Create stored procedure SP_ACCOUNT_USAGE_DATA
Procedure to sync SNOWFLAKE database into SHARE_USAGE database. The procedure will create the tables if they do not exists

```sql
Use role ACCOUNTADMIN;

CREATE OR REPLACE PROCEDURE SHARE_USAGE.ACCOUNT_USAGE.SP_ACCOUNT_STORAGE_DATA(LOAD_METHOD STRING)
RETURNS STRING
LANGUAGE javascript
strict
EXECUTE AS owner
AS

$$

// SET VARIABLES
var SP_VERSION = `2.3`;
var TASK_NAME = `TASK_ACCOUNT_STORAGE`;
var RUN_ID = Date.now().toString();

var full_script = `
Create table if not exists  ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG (
RUN_ID STRING,
TASK_NAME STRING,
OBJECT_NAME STRING,
EVENT_NAME STRING,
EVENT_TS timestamp_ntz,
SP_VERSION STRING,
EVENT_DATA VARIANT
);
/*cmd separator*/
Create  table if not exists ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'TABLE_STORAGE_USAGE', 'Started', current_timestamp(), '`+SP_VERSION+`' ,parse_json('{desc: "Fi"}');
/*cmd separator*/
Create table if not exists  ACCOUNT_USAGE.TABLE_STORAGE_USAGE as
Select  TO_DATE(current_timestamp()) DATE_ID,TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,  CONCAT(TABLE_CATALOG, '.',TABLE_SCHEMA, '.',TABLE_NAME) FULL_TABLE_NAME, Count(*) Storage_Objects
, MAX(ACTIVE_BYTES) MAX_ACTIVE_BYTES, SUM(ACTIVE_BYTES) SUM_ACTIVE_BYTES
, MAX(TIME_TRAVEL_BYTES) MAX_TIME_TRAVEL_BYTES, SUM(TIME_TRAVEL_BYTES) SUM_TIME_TRAVEL_BYTES
, MAX(ACTIVE_BYTES+TIME_TRAVEL_BYTES) MAX_OBJECT_BYTES,  SUM(ACTIVE_BYTES+TIME_TRAVEL_BYTES) SUM_OBJECT_BYTES
, MAX(FAILSAFE_BYTES) MAX_FAILSAFE_BYTES,  SUM(FAILSAFE_BYTES) SUM_FAILSAFE_BYTES
, SUM(CASE WHEN IS_TRANSIENT = 'YES' Then 0 else 1 end) SUM_IS_TRANSIENT
, MAX(CASE WHEN IS_TRANSIENT = 'YES' Then 0 else 1 end) MAX_IS_TRANSIENT
, Current_timestamp() CREATED
From SNOWFLAKE.ACCOUNT_USAGE.TABLE_STORAGE_METRICS
Where 1=0
Group By 1,2,3,4,5;
/*cmd separator*/
Delete from ACCOUNT_USAGE.TABLE_STORAGE_USAGE 
Where DATE_ID = TO_DATE(current_timestamp());
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'TABLE_STORAGE_USAGE', 'Delete current date', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{deleted: ', "number of rows deleted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Insert Into ACCOUNT_USAGE.TABLE_STORAGE_USAGE (DATE_ID,TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,FULL_TABLE_NAME, Storage_Objects,
MAX_ACTIVE_BYTES,SUM_ACTIVE_BYTES, MAX_TIME_TRAVEL_BYTES, SUM_TIME_TRAVEL_BYTES, MAX_OBJECT_BYTES, SUM_OBJECT_BYTES,
MAX_FAILSAFE_BYTES, SUM_FAILSAFE_BYTES,SUM_IS_TRANSIENT,MAX_IS_TRANSIENT,
CREATED)
Select  TO_DATE(current_timestamp()) DATE_ID,TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,  CONCAT(TABLE_CATALOG, '.',TABLE_SCHEMA, '.',TABLE_NAME) FULL_TABLE_NAME, Count(*) Storage_Objects
, MAX(ACTIVE_BYTES) MAX_ACTIVE_BYTES, SUM(ACTIVE_BYTES) SUM_ACTIVE_BYTES
, MAX(TIME_TRAVEL_BYTES) MAX_TIME_TRAVEL_BYTES, SUM(TIME_TRAVEL_BYTES) SUM_TIME_TRAVEL_BYTES
, MAX(ACTIVE_BYTES+TIME_TRAVEL_BYTES) MAX_OBJECT_BYTES,  SUM(ACTIVE_BYTES+TIME_TRAVEL_BYTES) SUM_OBJECT_BYTES
, MAX(FAILSAFE_BYTES) MAX_FAILSAFE_BYTES,  SUM(FAILSAFE_BYTES) SUM_FAILSAFE_BYTES
, SUM(CASE WHEN IS_TRANSIENT = 'YES' Then 0 else 1 end) SUM_IS_TRANSIENT
, MAX(CASE WHEN IS_TRANSIENT = 'YES' Then 0 else 1 end) MAX_IS_TRANSIENT
, Current_timestamp() CREATED
From SNOWFLAKE.ACCOUNT_USAGE.TABLE_STORAGE_METRICS
Group By 1,2,3,4,5;
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'TABLE_STORAGE_USAGE', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Create or replace table ACCOUNT_USAGE.TABLE_STORAGE_METRICS as
Select *, current_timestamp() CREATED
From "SNOWFLAKE"."ACCOUNT_USAGE"."TABLE_STORAGE_METRICS";
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'TABLE_STORAGE_METRICS', 'Overwrite', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{status: ','''', "status",'''',',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Create  table if not exists ACCOUNT_USAGE.DATABASE_STORAGE_USAGE_HISTORY as
Select USAGE_DATE,DATABASE_ID,DATABASE_NAME,DELETED,AVERAGE_DATABASE_BYTES,AVERAGE_FAILSAFE_BYTES , current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."DATABASE_STORAGE_USAGE_HISTORY"
Where 1=0;
/*cmd separator*/
Insert Into ACCOUNT_USAGE.DATABASE_STORAGE_USAGE_HISTORY (USAGE_DATE,DATABASE_ID,DATABASE_NAME,AVERAGE_DATABASE_BYTES,AVERAGE_FAILSAFE_BYTES ,CREATED,EXTRA_COLUMNS)
Select USAGE_DATE,DATABASE_ID,DATABASE_NAME,AVERAGE_DATABASE_BYTES,AVERAGE_FAILSAFE_BYTES , current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."DATABASE_STORAGE_USAGE_HISTORY"
Where USAGE_DATE > IFNULL((Select Max(USAGE_DATE) From ACCOUNT_USAGE.DATABASE_STORAGE_USAGE_HISTORY),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'DATABASE_STORAGE_USAGE_HISTORY', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
Create table if not exists ACCOUNT_USAGE.STORAGE_USAGE as
Select USAGE_DATE,STORAGE_BYTES,STAGE_BYTES,FAILSAFE_BYTES, current_timestamp() CREATED, ''::VARIANT EXTRA_COLUMNS
From "SNOWFLAKE"."ACCOUNT_USAGE"."STORAGE_USAGE"
Where 1=0;
/*cmd separator*/
Insert Into ACCOUNT_USAGE.STORAGE_USAGE (USAGE_DATE,STORAGE_BYTES,STAGE_BYTES,FAILSAFE_BYTES,CREATED)
Select USAGE_DATE,STORAGE_BYTES,STAGE_BYTES,FAILSAFE_BYTES, current_timestamp() CREATED
From "SNOWFLAKE"."ACCOUNT_USAGE"."STORAGE_USAGE"
Where USAGE_DATE > IFNULL((Select Max(USAGE_DATE) From STORAGE_USAGE),'2000-01-01');
/*cmd separator*/
INSERT INTO ACCOUNT_USAGE.SNOWLY_EXECUTION_LOG(RUN_ID, TASK_NAME, OBJECT_NAME, EVENT_NAME, EVENT_TS, SP_VERSION, EVENT_DATA)
SELECT '`+RUN_ID+`','`+TASK_NAME+`', 'STORAGE_USAGE', 'Insert', current_timestamp(), '`+SP_VERSION+`' ,(SELECT parse_json(concat('{inserted: ', "number of rows inserted",',query_id:','''',LAST_QUERY_ID(),'''','}'))  FROM TABLE(RESULT_SCAN(LAST_QUERY_ID())));
/*cmd separator*/
`
var message='';
try
{
for (j = 0; j < full_script.split(';').length; j++){

    curr_sql=full_script.split(';')[j];

    if(curr_sql && curr_sql.length>20){
        if(LOAD_METHOD=='FULL'){
        curr_sql = curr_sql.replace('table if not exists',' or replace table ')
        }
        var snowflake_statement = snowflake.createStatement( {sqlText: curr_sql});
        var result = snowflake_statement.execute();
        message=message+'|'+curr_sql;
    }
}
return 'Success'

    }
catch (err)  {

  var failure_msg = "Failed: " + err
    return failure_msg

  }

$$;
```
